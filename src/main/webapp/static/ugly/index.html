<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Warburtons Ugly Forms</title>
        <link type="text/css" href="/css/blitzer/jquery-ui-1.8.17.custom.css" rel="stylesheet" />	
    </head>
    <body>
        <div id="header" class="ui-widget">
        </div>

        <div id="contents" class="ui-widget">
            <div><a id="loginLogoutLink" href="#">Checking status...</a></div>
            <div><a href="/api/_admin/wbt/adminForms.html">Admin forms</a></div>
            <div><a href="userServiceForms.html">User Service forms</a></div>

            <h3>Warburtons Ugly Forms</h3>

            <hr/>
            
            | <button id="locationsButton">Locations</button>
            | <button id="productsButton">Products</button>
            |
            
            <hr/>

            <div id="uglyContents">Select a Resource's forms by clicking the above buttons.</div>
        </div>

        <div id="footer" class="ui-widget">
            <hr/>
            Ugly forms for Warburtons backend.
        </div>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.19/jquery-ui.min.js"></script>
        <script type="text/javascript" src="/js/jquery.json-2.3.min.js"></script>
        <script type="text/javascript" src="/js/jquery.jsonp-2.3.1.min.js"></script>
        <script type="text/javascript">
$.ajaxSetup( {
    cache: false,
    data: null
});

function getApiUrl() {
    return $("#contents").data('apiUrl');
}
function getOauthUrl() {
    return $("#contents").data('oauthUrl');
}
function getSigninUrl() {
    return $("#contents").data('signinUrl');
}
function getAccessToken() {
    return $("#contents").data('access_token');
}

function updateEndpoints(baseUrl) {
    $.ajax(baseUrl + "/api/endpoints", {
        async: false,
        dataType: 'json' 
    })
    .success(function(data) {
        $("#contents").data('apiUrl', data.apiUrl);
        $("#contents").data('oauthUrl', data.oauthUrl);
        $("#contents").data('signinUrl', data.signinUrl);
//        alert('getEndpoints ' + data.signinUrl);
        $("#loginLogoutLink").attr('href', 
            data.oauthUrl + 'authorize?client_id=localhost.generic-app&redirect_uri=/ugly/%23providerId=gekko&response_type=token');
            
        $("#loginLogoutLink").text('Login');
    });
}

function getUserMe() {
    var user = null;
//    alert('getUserMe ' + getOauthUrl());
    $.getJSON(getOauthUrl() + "user/me",
        {
            async: false,
            access_token: getAccessToken()
        },
        function(data) {
            user = data;
        });
    
    return user;
}

function getSigninStatus() {
    var user = null;
    $.getJSON(getApiUrl() + "user/v10/status",
        {
            async: false,
            access_token: getAccessToken()
        },
        function(data) {
            user = data;
        });
    
    return user;
}

function updateApiUrl() {
    var baseUrl = null;
    if (-1 < location.href.search('test.warburtons-test')) {
        baseUrl = 'http://test.warburtons-test.appspot.com';
    }
    else if (-1 < location.href.search('lab.warburtons-test')) {
        baseUrl = 'http://lab.warburtons-test.appspot.com';
    }
    else if (-1 < location.href.search('localhost')) {
        baseUrl = 'http://localhost:8929';
    }
    else if (-1 < location.href.search('warburtons-test.')) {
        baseUrl = 'http://warburtons-test.appspot.com';
    }
    else if (-1 < location.href.search('warburtons-stage.')) {
        baseUrl = 'http://warburtons-stage.appspot.com';
    }
    else {
        baseUrl = 'http://warburtons-prod.appspot.com';
    }
    updateEndpoints(baseUrl);
}

function getFragmentByName(name) {

    var match = RegExp('[&#]' + name + '=([^&]*)')
                    .exec(window.location.hash);

    return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
}

function getParameterByName(name) {

    var match = RegExp('[?&]' + name + '=([^&]*)')
                    .exec(window.location.search);

    return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
}

function registerFederated(accessToken, providerId, expiresIn) {
    $.getJSON(getOauthUrl() + "user/me",
        {
            async: false,
            access_token: getAccessToken()
        },
        function(user) {
            $("#contents").data('providerUserId', user.id);
            $.getJSON(getApiUrl() + "federated",
                {
                    access_token: accessToken,
                    providerId: providerId,
                    providerUserId: user.id,
                    expires_in: expiresIn
                })
                .success(function(data) {
                    $("#loginLogoutLink").attr('href', '?logout=true');
                    $("#loginLogoutLink").text('Logout'); 
                });
        });
}

function persistAccessToken() {
    var access_token = getFragmentByName('access_token');
    if (access_token) {
        var expiresIn = getFragmentByName('expires_in');
        $("#contents").data('access_token', access_token);
        var providerId = getFragmentByName('providerId');
        $("#contents").data('providerId', providerId);
        registerFederated(access_token, providerId, expiresIn);
        window.location = "#welcome";
    }
}

function updateLogin() {
    var user = getSigninStatus();
    $("#loginLogoutLink").attr('href', user ? 
        '?logout=true' : 
        getOauthUrl() + 'authorize?client_id=localhost.generic-app&redirect_uri=/ugly/%23providerId=gekko&response_type=token');
//        getSigninUrl() + 'redirect?url=/ugly/');
    $("#loginLogoutLink").text(user ? 'Logout ' + user.name : 'Login');
}

$("#locationsButton").button().click(function(){
    $("#uglyContents").load("location.html");
});

$("#productsButton").button().click(function(){
    $("#uglyContents").load("product.html");
});

$(function() {
    updateApiUrl();
    persistAccessToken();
//    updateLogin();
});

        </script>

    </body>
</html>